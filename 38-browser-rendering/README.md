>브라우저가 어떻게 HTML, CSS, Javascript 문서를 렌더링하는가

# 렌더링

![렌더링](https://github.com/agnes0304/modern-javascript-deepdive-docs/assets/86249667/82117a99-456a-4d32-b49f-9b7784c1e2f9)

1. 브라우저는 렌더링에 필요한 리소스, 서버에 요청 / 응답 GET
   >서버) 브라우저 요청 파일을 읽어 메모리에 저장 → 그 저장된 바이트를 리스폰스로

2. 렌더링 엔진은 HTML, CSS를 파싱해서 DOM, CSSOM을 생성 → 이를 결합하여 렌더트리를 생성. 
    > • 브라우저는 리스폰스 바이트를 HTML문서의 `<meta>` `charset` att에 저장된 인코딩 방식으로 문자열로 변환.
    ></br> • 토큰(문법적의미를 갖는 최소 단위)으로 분해
    ></br> • 토큰을 객체로 변환 → 노드를 생성
    ></br>&nbsp;&nbsp;&nbsp;&nbsp; • 토큰 내용에 따라 `문서 노드`, `요소 노드`, `어트리뷰트 노드`, `텍스트 노드`가 생성되고 노드는 DOM 기본 구성 요소가 된다.

3. JS엔진은 JS를 파싱해서 파스 트리(AST: abstract syntax tree)를 생성하고 바이트 코드로 변환 후 실행한다. 
    > • DOM api를 통해 DOM, CSSOM을 변경한다.

4. 변경된 DOM, CSSOM을 다시 렌더트리로 결합한다.

5. 렌더트리를 기반으로 html요소 레이아웃을 계산하고 브라우저에 페인팅한다.

</br>

## CSS파싱과 CSSOM

- 브라우저 렌더링 엔진은 DOM을 생성하다가 css로드하는 `<link>`, `<style>`를 만나면 DOM 생성을 잠깐 멈춘다.
- 각 태그 `href`에 지정된 CSS파일을 서버로 요청한다.
- CSSOM 생성 → html 파싱과 동일
- html 파싱 중단 지점으로 가서 DOM생성 재개한다.
- css상속을 반영하여 생성
    - body 요소에 적용한 폰트 사이즈는 아래 요소에 상속
    - `ul`에 적용한 프로퍼티는 `li`에 상속 등

</br>

## 렌더트리

- DOM, CSSOM을 결합하여 **렌더링을 위해** 구성한 자료구조
    - 브라우저 화면에 렌더링 되지 않는 노드와 css에 `display:none;`인 노드는 포함되지 않음.
- html 요소의 레이아웃 계산에 사용. 브라우저 화면에 픽셀을 렌더링하는 페인팅 처리에 입력.

</br>

## Javascript 파싱과 실행

- 렌더링 엔진, DOM을 생성하다가 `<script>` 를 만나면 생성을 중단
- 서버에 해당 태그 `src`에 정의된 파일 요청
- JS엔진에 제어권을 넘김
    - 소스코드 - 토큰 - `AST` - 바이트코드 - 인터프리터(실행)의 과정을 거친다.
- JS파싱과 실행이 종료되면 렌더링 엔진으로 제어권이 넘어와 html 파싱, DOM생성 재개

### 파서(Parser)

- 토큰 집합을 구문분석하여 AST를 생성
    - AST는 주로 인터프리터나 컴파일러가 사용
    - AST를 통해 타입스크립트, 바벨, 프리티어같은 transpiler를 구현할 수 있음.

### 바이트코드 생성과 실행

V8엔진의 경우 자주 사용되는 코드는 TurboFan이라는 컴파일러에 의해 optimized machine code로 컴파일되어 성능을 최적화한다. 

</br>

## 리플로우, 리페인트

- DOM api 조작으로 변경된 렌더트리를 기반으로 레이아웃과 페인트 과정을 재차 거쳐 브라우저에 다시 렌더링하는 과정
- reflow: 레이아웃 계산을 다시하는 것
    - 노드 추가, 삭제, 요소 크기, 위치변경, 윈도우 리사이징 등
- repaint: 화면에 픽셀 렌더링 다시하는 것
- 두 가지가 순차적으로 동시 진행되는 것은 아님

### 리렌더링

레이아웃 계산과 페인팅이 재실행되는 경우

- JS에 의한 노드 추가 및 삭제
- 뷰포트 사이즈 변경
- html 요소의 레이아웃 변경을 발생시키는 스타일 변경

</br>

## `async`, `defer`

- HTML5부터 도입 됨
- `<script>`에 의해 html 파싱이 블록되는 것을 방지.
- JS가 DOM api를 사용하기 전에 DOM과 CSSOM을 구성.
- script 태그를 통해 외부 js를 로드하는 경우에만 동작
- HTML 파싱과 JS 파일 로딩이 비동기적으로 동작.

### async, defer 이전에는
>`<script>`는 가능한 `<body>` 하단에 위치시킨다.


|키워드|설명| 
| :--- | :--- |
| `async` | • HTML 파싱(DOM)과 JS파일 로드가 비동기적으로 진행</br>• JS의 파싱과 실행은 파일이 로드된 직후에 진행. → 이때 HTML 파싱이 중단(DOM 스탑)</br>• 여러 개의 스크립트에 적용할 경우, 순서 상관없이 파일이 로드된 순서대로 파싱, 실행 |
| `defer` | • HTML 파싱과 JS파일 로드가 비동기적으로 진행</br>• JS파싱과 실행은 HTML파싱이 완료된 직후(DOM 생성 직후) 진행 |
